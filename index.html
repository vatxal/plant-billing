<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Plant Bill</title>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  padding: 10px;
  background: #f5f5f5;
}

input {
  width: 100%;
  box-sizing: border-box;
  padding: 6px;
  font-size: 14px;
}

table {
  width: 100%;
  border-collapse: collapse;
  background: white;
}

th, td {
  border: 1px solid #444;
  padding: 6px;
  text-align: center;
  font-size: 14px;
}

th {
  background: #eaeaea;
}

th:nth-child(1),
td:nth-child(1) {
  width: 45%;
  text-align: left;
  word-break: break-word;
}

th:nth-child(2), td:nth-child(2) { width: 10%; }
th:nth-child(3), td:nth-child(3) { width: 15%; }
th:nth-child(4), td:nth-child(4) { width: 15%; }
th:nth-child(5), td:nth-child(5) { width: 15%; }

button {
  padding: 10px;
  font-size: 16px;
  margin: 5px 0;
  width: 100%;
}
</style>
</head>

<body>

<h3>Customer Name</h3>
<input id="customerName" placeholder="Enter customer name">

<br><br>

<div id="captureArea">
  <table id="billTable">
    <tr>
      <th>Plant Name</th>
      <th>Qty</th>
      <th>Price</th>
      <th>Height (Ft)</th>
      <th>Total</th>
    </tr>
  </table>

  <h3 id="finalTotal">Grand Total: 0</h3>
</div>

<button onclick="addRow()">âž• Add Row</button>
<button onclick="capture(false)">Submit (English)</button>
<button onclick="capture(true)">Submit (Gujarati)</button>

<script>
const table = document.getElementById("billTable");
const customerName = document.getElementById("customerName");

function addRow() {
  const r = table.insertRow();
  for (let i = 0; i < 5; i++) {
    const c = r.insertCell();
    const inp = document.createElement("input");
    inp.type = (i === 1 || i === 2 || i === 3) ? "number" : "text";
    inp.oninput = calc;
    c.appendChild(inp);
  }
}

for (let i = 0; i < 10; i++) addRow();

function calc() {
  let total = 0;
  for (let i = 1; i < table.rows.length; i++) {
    const r = table.rows[i];
    const q = Number(r.cells[1].firstChild.value) || 0;
    const p = Number(r.cells[2].firstChild.value) || 0;
    const t = q * p;
    r.cells[4].firstChild.value = t.toFixed(2);
    total += t;
  }
  document.getElementById("finalTotal").innerText =
    "Grand Total: " + total.toFixed(2);
}

/* âœ… TRUE PHONETIC TRANSLITERATION */
function toGujarati(text) {
  const rules = [
    ["aa","àª†"],["ee","àªˆ"],["ii","àªˆ"],["oo","àªŠ"],["uu","àªŠ"],
    ["ai","àª"],["au","àª”"],
    ["kh","àª–"],["gh","àª˜"],["ch","àªš"],["jh","àª"],
    ["th","àª¥"],["dh","àª§"],["ph","àª«"],["bh","àª­"],
    ["sh","àª¶"]
  ];

  const map = {
    a:"àª…", b:"àª¬", c:"àª•", d:"àª¦", e:"àª", f:"àª«",
    g:"àª—", h:"àª¹", i:"àª‡", j:"àªœ", k:"àª•", l:"àª²",
    m:"àª®", n:"àª¨", o:"àª“", p:"àªª", r:"àª°",
    s:"àª¸", t:"àª¤", u:"àª‰", v:"àªµ", w:"àªµ",
    y:"àª¯", z:"àª"
  };

  return text.split(" ").map(word => {
    let w = word.toLowerCase();
    let out = "";

    while (w.length) {
      let matched = false;
      for (const [e,g] of rules) {
        if (w.startsWith(e)) {
          out += g;
          w = w.slice(e.length);
          matched = true;
          break;
        }
      }
      if (!matched) {
        out += map[w[0]] || w[0];
        w = w.slice(1);
      }
    }
    return out;
  }).join(" ");
}

/* âœ… GUARANTEED MOBILE CAPTURE */
async function capture(guj) {
  if (!customerName.value.trim()) {
    alert("Enter customer name");
    return;
  }

  const area = document.getElementById("captureArea");
  const originalWidth = area.style.width;
  area.style.width = "900px";

  if (guj) {
    for (let i = 1; i < table.rows.length; i++) {
      const inp = table.rows[i].cells[0].firstChild;
      inp.dataset.eng = inp.value;
      inp.value = toGujarati(inp.value);
    }

    /* ðŸ”‘ FORCE MOBILE REPAINT */
    await new Promise(r => requestAnimationFrame(r));
  }

  const canvas = await html2canvas(area, { scale: 2 });
  const blob = await new Promise(r => canvas.toBlob(r));

  try {
    await navigator.clipboard.write([
      new ClipboardItem({ "image/png": blob })
    ]);
    alert("Image copied! Paste in WhatsApp ðŸ“²");
  } catch {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download =
      customerName.value + (guj ? "_Gujarati" : "") + ".png";
    a.click();
  }

  area.style.width = originalWidth;

  if (guj) {
    for (let i = 1; i < table.rows.length; i++) {
      const inp = table.rows[i].cells[0].firstChild;
      inp.value = inp.dataset.eng;
    }
  }
}
</script>

</body>
</html>
